"use strict";function isObject(t){return t===Object(t)}function makeStackTraceLong(t,e){if(hasStacks&&e.stack&&"object"==typeof t&&null!==t&&t.stack&&-1===t.stack.indexOf(STACK_JUMP_SEPARATOR)){for(var n=[],i=e;i&&handlers.get(i);i=handlers.get(i).became)i.stack&&n.unshift(i.stack);n.unshift(t.stack);var o=n.join("\n"+STACK_JUMP_SEPARATOR+"\n");t.stack=filterStackString(o)}}function filterStackString(t){if(Q.isIntrospective)return t;for(var e=t.split("\n"),n=[],i=0;i<e.length;++i){var o=e[i];isInternalFrame(o)||isNodeFrame(o)||!o||n.push(o)}return n.join("\n")}function isNodeFrame(t){return-1!==t.indexOf("(module.js:")||-1!==t.indexOf("(node.js:")}function getFileNameAndLineNumber(t){var e=/at .+ \((.+):(\d+):(?:\d+)\)$/.exec(t);if(e)return[e[1],Number(e[2])];var n=/at ([^ ]+):(\d+):(?:\d+)$/.exec(t);if(n)return[n[1],Number(n[2])];var i=/.*@(.+):(\d+)$/.exec(t);return i?[i[1],Number(i[2])]:void 0}function isInternalFrame(t){var e=getFileNameAndLineNumber(t);if(!e)return!1;var n=e[0],i=e[1];return n===qFileName&&i>=qStartingLine&&qEndingLine>=i}function captureLine(){if(hasStacks)try{throw new Error}catch(t){var e=t.stack.split("\n"),n=e[0].indexOf("@")>0?e[1]:e[2],i=getFileNameAndLineNumber(n);if(!i)return;return qFileName=i[0],i[1]}}function deprecate(t,e,n){return function(){return"undefined"!=typeof console&&"function"==typeof console.warn&&(n?console.warn(e+" is deprecated, use "+n+" instead.",new Error("").stack):console.warn(e+" is deprecated.",new Error("").stack)),t.apply(this,arguments)}}function Q_inspect(t){var e=handlers.get(t);return e&&e.became?(e=follow(e),handlers.set(t,e),e):e}function follow(t){return t.became?(t.became=follow(t.became),t.became):t}function Q(t){return Q_isPromise(t)?t:isThenable(t)?(thenables.has(t)||thenables.set(t,new Promise(new Thenable(t))),thenables.get(t)):new Promise(new Fulfilled(t))}function Q_reject(t){return new Promise(new Rejected(t))}function defer(){var t=new Pending,e=new Promise(t),n=new Deferred(e);if(Q.longStackSupport&&hasStacks)try{throw new Error}catch(i){e.stack=i.stack.substring(i.stack.indexOf("\n")+1)}return n}function Q_all(t){function e(){s=-1/0;for(var t=0;t<a.length;t++)a[t]>s&&(s=a[t])}if(Q_isPromise(t))return"undefined"!=typeof console&&"function"==typeof console.warn&&console.warn("Q.all no longer directly unwraps a promise. Use Q(array).all()"),Q(t).all();var n,i=0,o=defer(),r=Array(t.length),a=[],s=-1/0;return Array.prototype.forEach.call(t,function(l,c){var u;Q_isPromise(l)&&"fulfilled"===(u=Q_inspect(l)).state?r[c]=u.value:(++i,l=Q(l),l.then(function(t){r[c]=t,0===--i&&o.resolve(r)},o.reject),l.observeEstimate(function(i){var r=a[c];a[c]=i,i>s?s=i:r===s&&s>=i&&e(),a.length===t.length&&s!==n&&(o.setEstimate(s),n=s)}))}),0===i&&o.resolve(r),o.promise}function Q_allSettled(t){return Q_isPromise(t)?("undefined"!=typeof console&&"function"==typeof console.warn&&console.warn("Q.allSettled no longer directly unwraps a promise. Use Q(array).allSettled()"),Q(t).allSettled()):Q_all(t.map(function(t){function e(){return t.inspect()}return t=Q(t),t.then(e,e)}))}function Q_spread(t,e,n){return Q(t).spread(e,n)}function Q_race(t){return new Promise(function(e){t.forEach(function(t){Q(t).then(e.resolve,e.reject)})})}function Promise_function(t){return function(){for(var e=new Array(arguments.length),n=0;n<arguments.length;n++)e[n]=arguments[n];return Q(t).apply(this,e)}}function Q_async(t){return function(){function e(t,e){var r;try{r=n[t](e)}catch(a){return Q_reject(a)}return r.done?Q(r.value):Q(r.value).then(i,o)}var n=t.apply(this,arguments),i=e.bind(e,"next"),o=e.bind(e,"throw");return i()}}function Q_spawn(t){Q_async(t)().done()}function Promise(t){if(!(this instanceof Promise))return new Promise(t);if("function"==typeof t){var e=t,n=defer();t=Q_inspect(n.promise);try{e(n.resolve,n.reject,n.setEstimate)}catch(i){n.reject(i)}}handlers.set(this,t)}function Promise_resolve(t){return Q(t)}function Q_isPromise(t){return isObject(t)&&!!handlers.get(t)}function isThenable(t){return isObject(t)&&"function"==typeof t.then}function Promise_rethrow(t){throw t}function Deferred(t){this.promise=t,promises.set(this,t);var e=this,n=this.resolve;this.resolve=function(t){n.call(e,t)};var i=this.reject;this.reject=function(t){i.call(e,t)}}function Fulfilled(t){this.value=t,this.estimate=Date.now()}function Rejected(t){this.reason=t,this.estimate=1/0}function Pending(){this.messages=[],this.observers=[],this.estimate=1/0}function Thenable(t){this.thenable=t,this.became=null,this.estimate=1/0}function makeNodebackResolver(t,e){return e===!0?function(e){if(e)t(Q_reject(e));else{for(var n=new Array(Math.max(0,arguments.length-1)),i=1;i<arguments.length;i++)n[i-1]=arguments[i];t(n)}}:e?function(n){if(n)t(Q_reject(n));else{var i={};for(var o in e)i[e[o]]=arguments[o+1];t(i)}}:function(e,n){e?t(Q_reject(e)):t(n)}}var hasStacks=!1;try{throw new Error}catch(e){hasStacks=!!e.stack}var qStartingLine=captureLine(),qFileName;require("collections/shim");var WeakMap=require("collections/weak-map"),Iterator=require("collections/iterator"),asap=require("asap"),STACK_JUMP_SEPARATOR="From previous event:",handlers=new WeakMap,theViciousCycleError=new Error("Can't resolve a promise with itself"),theViciousCycleRejection=Q_reject(theViciousCycleError),theViciousCycle=Q_inspect(theViciousCycleRejection),thenables=new WeakMap;module.exports=Q,Q.longStackSupport=!1,Q.reject=Q_reject,Q.defer=defer,Q.when=function(t,e,n,i){return Q(t).then(e,n,i)},Q.all=Q_all,Q.allSettled=Q_allSettled,Q.delay=function(t,e){return void 0===e&&(e=t,t=void 0),Q(t).delay(e)},Q.timeout=function(t,e,n){return Q(t).timeout(e,n)},Q.spread=Q_spread,Q.join=function(t,e){return Q.spread([t,e],function(t,e){if(t===e)return t;throw new Error("Can't join: not the same: "+t+" "+e)})},Q.race=Q_race,Q.try=function(t){return Q(t).dispatch("call",[[]])},Q.function=Promise_function,Q.promised=function(t){return function(){for(var e=new Array(arguments.length),n=0;n<arguments.length;n++)e[n]=arguments[n];return Q_spread([this,Q_all(e)],function(e,n){return t.apply(e,n)})}},Q.passByCopy=Q.push=function(t){return Object(t)!==t||Q_isPromise(t)||passByCopies.set(t,!0),t},Q.isPortable=function(t){return Object(t)===t&&passByCopies.has(t)};var passByCopies=new WeakMap;Q.async=Q_async,Q.spawn=Q_spawn,Q.Promise=Promise,Promise.all=Q_all,Promise.race=Q_race,Promise.resolve=Promise_resolve,Promise.reject=Q_reject,Q.isPromise=Q_isPromise,Promise.prototype.inspect=function(){return Q_inspect(this).inspect()},Promise.prototype.isPending=function(){return"pending"===Q_inspect(this).state},Promise.prototype.isFulfilled=function(){return"fulfilled"===Q_inspect(this).state},Promise.prototype.isRejected=function(){return"rejected"===Q_inspect(this).state},Promise.prototype.toString=function(){return"[object Promise]"},Promise.prototype.then=function(t,e,n){var i,o=this,r=defer();i="function"==typeof t?function(e){try{r.resolve(t.call(void 0,e))}catch(n){r.reject(n)}}:r.resolve;var a;if(a="function"==typeof e?function(t){try{r.resolve(e.call(void 0,t))}catch(n){r.reject(n)}}:r.reject,this.done(i,a),void 0!==n){var s=function(){r.setEstimate(o.getEstimate()+n)};this.observeEstimate(s),s()}return r.promise},Promise.prototype.done=function(t,e){var n=this,i=!1;asap(function(){var o;"function"==typeof t&&(o=Q.onerror?function(e){if(!i){i=!0;try{t.call(void 0,e)}catch(n){(Q.onerror||Promise_rethrow)(n)}}}:function(e){i||(i=!0,t.call(void 0,e))});var r;r="function"==typeof e&&Q.onerror?function(t){if(!i){i=!0,makeStackTraceLong(t,n);try{e.call(void 0,t)}catch(o){(Q.onerror||Promise_rethrow)(o)}}}:"function"==typeof e?function(t){i||(i=!0,makeStackTraceLong(t,n),e.call(void 0,t))}:Q.onerror||Promise_rethrow,"object"==typeof process&&process.domain&&(r=process.domain.bind(r)),Q_inspect(n).dispatch(o,"then",[r])})},Promise.prototype.thenResolve=function(t){return t=Q(t),Q_all([this,t]).then(function(){return t},null,0)},Promise.prototype.thenReject=function(t){return this.then(function(){throw t},null,0)},Promise.prototype.all=function(){return this.then(Q_all)},Promise.prototype.allSettled=function(){return this.then(Q_allSettled)},Promise.prototype.catch=function(t){return this.then(void 0,t)},Promise.prototype.finally=function(t,e){return t?(t=Q(t),this.then(function(e){return t.call().then(function(){return e})},function(e){return t.call().then(function(){throw e})},e)):this},Promise.prototype.observeEstimate=function(t){return this.dispatch("estimate",[t]),this},Promise.prototype.getEstimate=function(){return Q_inspect(this).estimate},Promise.prototype.dispatch=function(t,e){var n=defer();return this.rawDispatch(n.resolve,t,e),n.promise},Promise.prototype.rawDispatch=function(t,e,n){var i=this;asap(function(){Q_inspect(i).dispatch(t,e,n)})},Promise.prototype.get=function(t){return this.dispatch("get",[t])},Promise.prototype.invoke=function(t){for(var e=new Array(arguments.length-1),n=1;n<arguments.length;n++)e[n-1]=arguments[n];return this.dispatch("invoke",[t,e])},Promise.prototype.apply=function(t,e){return this.dispatch("call",[e,t])},Promise.prototype.call=function(t){for(var e=new Array(Math.max(0,arguments.length-1)),n=1;n<arguments.length;n++)e[n-1]=arguments[n];return this.dispatch("call",[e,t])},Promise.prototype.bind=function(t){for(var e=this,n=new Array(Math.max(0,arguments.length-1)),i=1;i<arguments.length;i++)n[i-1]=arguments[i];return function(){for(var i=n.slice(),o=0;o<arguments.length;o++)i[i.length]=arguments[o];return e.dispatch("call",[i,t])}},Promise.prototype.keys=function(){return this.dispatch("keys",[])},Promise.prototype.iterate=function(){return this.dispatch("iterate",[])},Promise.prototype.spread=function(t,e,n){return this.all().then(function(e){return t.apply(void 0,e)},e,n)},Promise.prototype.timeout=function(t,e){var n=defer(),i=setTimeout(function(){n.reject(new Error(e||"Timed out after "+t+" ms"))},t);return this.then(function(t){clearTimeout(i),n.resolve(t)},function(t){clearTimeout(i),n.reject(t)}),n.promise},Promise.prototype.delay=function(t){return this.then(function(e){var n=defer();return n.setEstimate(Date.now()+t),setTimeout(function(){n.resolve(e)},t),n.promise},null,t)},Promise.prototype.pull=function(){return this.dispatch("pull",[])};var promises=new WeakMap;Deferred.prototype.resolve=function(t){var e=Q_inspect(promises.get(this));e.messages&&e.become(Q(t))},Deferred.prototype.reject=function(t){var e=Q_inspect(promises.get(this));e.messages&&e.become(Q_reject(t))},Deferred.prototype.setEstimate=function(t){if(t=+t,t!==t&&(t=1/0),1e12>t&&t!==-1/0)throw new Error("Estimate values should be a number of miliseconds in the future");var e=Q_inspect(promises.get(this));e.setEstimate&&e.setEstimate(t)},Fulfilled.prototype.state="fulfilled",Fulfilled.prototype.inspect=function(){return{state:"fulfilled",value:this.value}},Fulfilled.prototype.dispatch=function(t,e,n){var i;if("then"===e||"get"===e||"call"===e||"invoke"===e||"keys"===e||"iterate"===e||"pull"===e)try{i=this[e].apply(this,n)}catch(o){i=Q_reject(o)}else if("estimate"===e)n[0].call(void 0,this.estimate);else{var r=new Error("Fulfilled promises do not support the "+e+" operator");i=Q_reject(r)}t&&t(i)},Fulfilled.prototype.then=function(){return this.value},Fulfilled.prototype.get=function(t){return this.value[t]},Fulfilled.prototype.invoke=function(t,e){return this.value[t].apply(this.value,e)},Fulfilled.prototype.call=function(t,e){return this.value.apply(e,t)},Fulfilled.prototype.keys=function(){return Object.keys(this.value)},Fulfilled.prototype.iterate=function(){return new Iterator(this.value)},Fulfilled.prototype.pull=function(){var t;if(Object(this.value)===this.value){t=Array.isArray(this.value)?[]:{};for(var e in this.value)t[e]=this.value[e]}else t=this.value;return Q.push(t)},Rejected.prototype.state="rejected",Rejected.prototype.inspect=function(){return{state:"rejected",reason:this.reason}},Rejected.prototype.dispatch=function(t,e,n){var i;i="then"===e?this.then(t,n[0]):this,t&&t(i)},Rejected.prototype.then=function(t,e){return e?e(this.reason):this},Pending.prototype.state="pending",Pending.prototype.inspect=function(){return{state:"pending"}},Pending.prototype.dispatch=function(t,e,n){if(this.messages.push([t,e,n]),"estimate"===e){this.observers.push(n[0]);var i=this;asap(function(){n[0].call(void 0,i.estimate)})}},Pending.prototype.become=function(t){this.became=theViciousCycle;var e=Q_inspect(t);this.became=e,handlers.set(t,e),this.promise=void 0,this.messages.forEach(function(e){asap(function(){var n=Q_inspect(t);n.dispatch.apply(n,e)})}),this.messages=void 0,this.observers=void 0},Pending.prototype.setEstimate=function(t){if(this.observers){var e=this;e.estimate=t,this.observers.forEach(function(e){asap(function(){e.call(void 0,t)})})}},Thenable.prototype.state="thenable",Thenable.prototype.inspect=function(){return{state:"pending"}},Thenable.prototype.cast=function(){if(!this.became){var t=defer(),e=this.thenable;asap(function(){try{e.then(t.resolve,t.reject)}catch(n){t.reject(n)}}),this.became=Q_inspect(t.promise)}return this.became},Thenable.prototype.dispatch=function(t,e,n){this.cast().dispatch(t,e,n)},Q.ninvoke=function(t,e){for(var n=new Array(Math.max(0,arguments.length-1)),i=2;i<arguments.length;i++)n[i-2]=arguments[i];var o=Q.defer();return n[i-2]=makeNodebackResolver(o.resolve),Q(t).dispatch("invoke",[e,n]).catch(o.reject),o.promise},Q.denodeify=function(t,e){return function(){for(var n=new Array(arguments.length+1),i=0;i<arguments.length;i++)n[i]=arguments[i];var o=Q.defer();return n[i]=makeNodebackResolver(o.resolve,e),Q(t).apply(this,n).catch(o.reject),o.promise}},Promise.prototype.nodeify=function(t){return t?(this.done(function(e){t(null,e)},t),void 0):this},Q.nextTick=deprecate(asap,"nextTick","asap package"),Q.resolve=deprecate(Q,"resolve","Q"),Q.fulfill=deprecate(Q,"fulfill","Q"),Q.isPromiseAlike=deprecate(isThenable,"isPromiseAlike","(not supported)"),Q.fail=deprecate(function(t,e){return Q(t).catch(e)},"Q.fail","Q(value).catch"),Q.fin=deprecate(function(t,e){return Q(t).finally(e)},"Q.fin","Q(value).finally"),Q.progress=deprecate(function(t){return t},"Q.progress","no longer supported"),Q.thenResolve=deprecate(function(t,e){return Q(t).thenResolve(e)},"thenResolve","Q(value).thenResolve"),Q.thenReject=deprecate(function(t,e){return Q(t).thenResolve(e)},"thenResolve","Q(value).thenResolve"),Q.isPending=deprecate(function(t){return Q(t).isPending()},"isPending","Q(value).isPending"),Q.isFulfilled=deprecate(function(t){return Q(t).isFulfilled()},"isFulfilled","Q(value).isFulfilled"),Q.isRejected=deprecate(function(t){return Q(t).isRejected()},"isRejected","Q(value).isRejected"),Q.master=deprecate(function(t){return t},"master","no longer necessary"),Q.makePromise=function(){throw new Error("makePromise is no longer supported")},Q.dispatch=deprecate(function(t,e,n){return Q(t).dispatch(e,n)},"dispatch","Q(value).dispatch"),Q.get=deprecate(function(t,e){return Q(t).get(e)},"get","Q(value).get"),Q.keys=deprecate(function(t){return Q(t).keys()},"keys","Q(value).keys"),Q.post=deprecate(function(t,e,n){return Q(t).post(e,n)},"post","Q(value).invoke (spread arguments)"),Q.mapply=deprecate(function(t,e,n){return Q(t).post(e,n)},"post","Q(value).invoke (spread arguments)"),Q.send=deprecate(function(t,e){return Q(t).post(e,Array.prototype.slice.call(arguments,2))},"send","Q(value).invoke"),Q.set=function(){throw new Error("Q.set no longer supported")},Q.delete=function(){throw new Error("Q.delete no longer supported")},Q.nearer=deprecate(function(t){return Q_isPromise(t)&&t.isFulfilled()?t.inspect().value:t},"nearer","inspect().value (+nuances)"),Q.fapply=deprecate(function(t,e){return Q(t).dispatch("call",[e])},"fapply","Q(callback).apply(thisp, args)"),Q.fcall=deprecate(function(t){return Q(t).dispatch("call",[Array.prototype.slice.call(arguments,1)])},"fcall","Q(callback).call(thisp, ...args)"),Q.fbind=deprecate(function(t){var e=Q(t),n=Array.prototype.slice.call(arguments,1);return function(){return e.dispatch("call",[n.concat(Array.prototype.slice.call(arguments)),this])}},"fbind","bind with thisp"),Q.promise=deprecate(Promise,"promise","Promise"),Promise.prototype.fapply=deprecate(function(t){return this.dispatch("call",[t])},"fapply","apply with thisp"),Promise.prototype.fcall=deprecate(function(){return this.dispatch("call",[Array.prototype.slice.call(arguments)])},"fcall","try or call with thisp"),Promise.prototype.fail=deprecate(function(t){return this.catch(t)},"fail","catch"),Promise.prototype.fin=deprecate(function(t){return this.finally(t)},"fin","finally"),Promise.prototype.set=function(){throw new Error("Promise set no longer supported")},Promise.prototype.delete=function(){throw new Error("Promise delete no longer supported")},Deferred.prototype.notify=deprecate(function(){},"notify","no longer supported"),Promise.prototype.progress=deprecate(function(){return this},"progress","no longer supported"),Promise.prototype.mapply=deprecate(function(t,e){return this.dispatch("invoke",[t,e])},"mapply","invoke"),Promise.prototype.fbind=deprecate(function(){return Q.fbind.apply(Q,[void 0].concat(Array.prototype.slice.call(arguments)))},"fbind","bind(thisp, ...args)"),Promise.prototype.send=deprecate(function(){return this.dispatch("invoke",[name,Array.prototype.slice.call(arguments,1)])},"send","invoke"),Promise.prototype.mcall=deprecate(function(){return this.dispatch("invoke",[name,Array.prototype.slice.call(arguments,1)])},"mcall","invoke"),Promise.prototype.passByCopy=deprecate(function(t){return t},"passByCopy","Q.passByCopy"),Q.nfapply=deprecate(function(t,e){var n=Q.defer(),i=Array.prototype.slice.call(e);return i.push(makeNodebackResolver(n.resolve)),Q(t).apply(this,i).catch(n.reject),n.promise},"nfapply"),Promise.prototype.nfapply=deprecate(function(t){return Q.nfapply(this,t)},"nfapply"),Q.nfcall=deprecate(function(t){var e=Array.prototype.slice.call(arguments,1);return Q.nfapply(t,e)},"nfcall"),Promise.prototype.nfcall=deprecate(function(){for(var t=new Array(arguments.length),e=0;e<arguments.length;e++)t[e]=arguments[e];return Q.nfapply(this,t)},"nfcall"),Q.nfbind=deprecate(function(t){var e=Array.prototype.slice.call(arguments,1);return function(){var n=e.concat(Array.prototype.slice.call(arguments)),i=Q.defer();return n.push(makeNodebackResolver(i.resolve)),Q(t).apply(this,n).catch(i.reject),i.promise}},"nfbind","denodeify (with caveats)"),Promise.prototype.nfbind=deprecate(function(){for(var t=new Array(arguments.length),e=0;e<arguments.length;e++)t[e]=arguments[e];return Q.nfbind(this,t)},"nfbind","denodeify (with caveats)"),Q.nbind=deprecate(function(t,e){var n=Array.prototype.slice.call(arguments,2);return function(){function i(){return t.apply(e,arguments)}var o=n.concat(Array.prototype.slice.call(arguments)),r=Q.defer();return o.push(makeNodebackResolver(r.resolve)),Q(i).apply(this,o).catch(r.reject),r.promise}},"nbind","denodeify (with caveats)"),Q.npost=deprecate(function(t,e,n){var i=Q.defer();return n.push(makeNodebackResolver(i.resolve)),Q(t).dispatch("invoke",[e,n]).catch(i.reject),i.promise},"npost","ninvoke (with spread arguments)"),Promise.prototype.npost=deprecate(function(t,e){return Q.npost(this,t,e)},"npost","Q.ninvoke (with caveats)"),Q.makeNodeResolver=deprecate(makeNodebackResolver,"makeNodeResolver"),Promise.prototype.ninvoke=deprecate(function(t){for(var e=new Array(arguments.length-1),n=1;n<arguments.length;n++)e[n-1]=arguments[n];return Q.npost(this,t,e)},"ninvoke","Q.ninvoke"),Q.nmapply=deprecate(Q.nmapply,"nmapply","q/node nmapply"),Promise.prototype.nmapply=deprecate(Promise.prototype.npost,"nmapply","Q.nmapply"),Q.nsend=deprecate(Q.ninvoke,"nsend","q/node ninvoke"),Q.nmcall=deprecate(Q.ninvoke,"nmcall","q/node ninvoke"),Promise.prototype.nsend=deprecate(Promise.prototype.ninvoke,"nsend","q/node ninvoke"),Promise.prototype.nmcall=deprecate(Promise.prototype.ninvoke,"nmcall","q/node ninvoke");var qEndingLine=captureLine();