"use strict";function isObject(e){return e===Object(e)}function makeStackTraceLong(e,t){if(hasStacks&&t.stack&&"object"==typeof e&&null!==e&&e.stack&&-1===e.stack.indexOf(STACK_JUMP_SEPARATOR)){for(var n=[],i=t;i&&handlers.get(i);i=handlers.get(i).became)i.stack&&n.unshift(i.stack);n.unshift(e.stack);var r=n.join("\n"+STACK_JUMP_SEPARATOR+"\n");e.stack=filterStackString(r)}}function filterStackString(e){if(Q.isIntrospective)return e;for(var t=e.split("\n"),n=[],i=0;i<t.length;++i){var r=t[i];isInternalFrame(r)||isNodeFrame(r)||!r||n.push(r)}return n.join("\n")}function isNodeFrame(e){return-1!==e.indexOf("(module.js:")||-1!==e.indexOf("(node.js:")}function getFileNameAndLineNumber(e){var t=/at .+ \((.+):(\d+):(?:\d+)\)$/.exec(e);if(t)return[t[1],Number(t[2])];var n=/at ([^ ]+):(\d+):(?:\d+)$/.exec(e);if(n)return[n[1],Number(n[2])];var i=/.*@(.+):(\d+)$/.exec(e);return i?[i[1],Number(i[2])]:void 0}function isInternalFrame(e){var t=getFileNameAndLineNumber(e);if(!t)return!1;var n=t[0],i=t[1];return n===qFileName&&i>=qStartingLine&&qEndingLine>=i}function captureLine(){if(hasStacks)try{throw new Error}catch(e){var t=e.stack.split("\n"),n=t[0].indexOf("@")>0?t[1]:t[2],i=getFileNameAndLineNumber(n);if(!i)return;return qFileName=i[0],i[1]}}function deprecate(e,t,n){return function(){return"undefined"!=typeof console&&"function"==typeof console.warn&&(n?console.warn(t+" is deprecated, use "+n+" instead.",new Error("").stack):console.warn(t+" is deprecated.",new Error("").stack)),e.apply(this,arguments)}}function Q_inspect(e){var t=handlers.get(e);return t&&t.became?(t=follow(t),handlers.set(e,t),t):t}function follow(e){return e.became?(e.became=follow(e.became),e.became):e}function Q(e){return Q_isPromise(e)?e:isThenable(e)?(thenables.has(e)||thenables.set(e,new Promise(new Thenable(e))),thenables.get(e)):new Promise(new Fulfilled(e))}function Q_reject(e){return new Promise(new Rejected(e))}function defer(){var e=new Pending,t=new Promise(e),n=new Deferred(t);if(Q.longStackSupport&&hasStacks)try{throw new Error}catch(i){t.stack=i.stack.substring(i.stack.indexOf("\n")+1)}return n}function Q_all(e){function t(){s=-1/0;for(var e=0;e<a.length;e++)a[e]>s&&(s=a[e])}if(Q_isPromise(e))return"undefined"!=typeof console&&"function"==typeof console.warn&&console.warn("Q.all no longer directly unwraps a promise. Use Q(array).all()"),Q(e).all();var n,i=0,r=defer(),o=Array(e.length),a=[],s=-1/0;return Array.prototype.forEach.call(e,function(u,l){var c;Q_isPromise(u)&&"fulfilled"===(c=Q_inspect(u)).state?o[l]=c.value:(++i,u=Q(u),u.then(function(e){o[l]=e,0===--i&&r.resolve(o)},r.reject),u.observeEstimate(function(i){var o=a[l];a[l]=i,i>s?s=i:o===s&&s>=i&&t(),a.length===e.length&&s!==n&&(r.setEstimate(s),n=s)}))}),0===i&&r.resolve(o),r.promise}function Q_allSettled(e){return Q_isPromise(e)?("undefined"!=typeof console&&"function"==typeof console.warn&&console.warn("Q.allSettled no longer directly unwraps a promise. Use Q(array).allSettled()"),Q(e).allSettled()):Q_all(e.map(function(e){function t(){return e.inspect()}return e=Q(e),e.then(t,t)}))}function Q_spread(e,t,n){return Q(e).spread(t,n)}function Q_race(e){return new Promise(function(t){e.forEach(function(e){Q(e).then(t.resolve,t.reject)})})}function Promise_function(e){return function(){for(var t=new Array(arguments.length),n=0;n<arguments.length;n++)t[n]=arguments[n];return Q(e).apply(this,t)}}function Q_async(e){return function(){function t(e,t){var o;try{o=n[e](t)}catch(a){return Q_reject(a)}return o.done?Q(o.value):Q(o.value).then(i,r)}var n=e.apply(this,arguments),i=t.bind(t,"next"),r=t.bind(t,"throw");return i()}}function Q_spawn(e){Q_async(e)().done()}function Promise(e){if(!(this instanceof Promise))return new Promise(e);if("function"==typeof e){var t=e,n=defer();e=Q_inspect(n.promise);try{t(n.resolve,n.reject,n.setEstimate)}catch(i){n.reject(i)}}handlers.set(this,e)}function Promise_resolve(e){return Q(e)}function Q_isPromise(e){return isObject(e)&&!!handlers.get(e)}function isThenable(e){return isObject(e)&&"function"==typeof e.then}function Promise_rethrow(e){throw e}function Deferred(e){this.promise=e,promises.set(this,e);var t=this,n=this.resolve;this.resolve=function(e){n.call(t,e)};var i=this.reject;this.reject=function(e){i.call(t,e)}}function Fulfilled(e){this.value=e,this.estimate=Date.now()}function Rejected(e){this.reason=e,this.estimate=1/0}function Pending(){this.messages=[],this.observers=[],this.estimate=1/0}function Thenable(e){this.thenable=e,this.became=null,this.estimate=1/0}function makeNodebackResolver(e,t){return t===!0?function(t){if(t)e(Q_reject(t));else{for(var n=new Array(Math.max(0,arguments.length-1)),i=1;i<arguments.length;i++)n[i-1]=arguments[i];e(n)}}:t?function(n){if(n)e(Q_reject(n));else{var i={};for(var r in t)i[t[r]]=arguments[r+1];e(i)}}:function(t,n){t?e(Q_reject(t)):e(n)}}var hasStacks=!1;try{throw new Error}catch(e){hasStacks=!!e.stack}var qStartingLine=captureLine(),qFileName;require("collections/shim");var WeakMap=require("collections/weak-map"),Iterator=require("collections/iterator"),asap=require("asap"),STACK_JUMP_SEPARATOR="From previous event:",handlers=new WeakMap,theViciousCycleError=new Error("Can't resolve a promise with itself"),theViciousCycleRejection=Q_reject(theViciousCycleError),theViciousCycle=Q_inspect(theViciousCycleRejection),thenables=new WeakMap;module.exports=Q,Q.longStackSupport=!1,Q.reject=Q_reject,Q.defer=defer,Q.when=function(e,t,n,i){return Q(e).then(t,n,i)},Q.all=Q_all,Q.allSettled=Q_allSettled,Q.delay=function(e,t){return void 0===t&&(t=e,e=void 0),Q(e).delay(t)},Q.timeout=function(e,t,n){return Q(e).timeout(t,n)},Q.spread=Q_spread,Q.join=function(e,t){return Q.spread([e,t],function(e,t){if(e===t)return e;throw new Error("Can't join: not the same: "+e+" "+t)})},Q.race=Q_race,Q.try=function(e){return Q(e).dispatch("call",[[]])},Q.function=Promise_function,Q.promised=function(e){return function(){for(var t=new Array(arguments.length),n=0;n<arguments.length;n++)t[n]=arguments[n];return Q_spread([this,Q_all(t)],function(t,n){return e.apply(t,n)})}},Q.passByCopy=Q.push=function(e){return Object(e)!==e||Q_isPromise(e)||passByCopies.set(e,!0),e},Q.isPortable=function(e){return Object(e)===e&&passByCopies.has(e)};var passByCopies=new WeakMap;Q.async=Q_async,Q.spawn=Q_spawn,Q.Promise=Promise,Promise.all=Q_all,Promise.race=Q_race,Promise.resolve=Promise_resolve,Promise.reject=Q_reject,Q.isPromise=Q_isPromise,Promise.prototype.inspect=function(){return Q_inspect(this).inspect()},Promise.prototype.isPending=function(){return"pending"===Q_inspect(this).state},Promise.prototype.isFulfilled=function(){return"fulfilled"===Q_inspect(this).state},Promise.prototype.isRejected=function(){return"rejected"===Q_inspect(this).state},Promise.prototype.toString=function(){return"[object Promise]"},Promise.prototype.then=function(e,t,n){var i,r=this,o=defer();i="function"==typeof e?function(t){try{o.resolve(e.call(void 0,t))}catch(n){o.reject(n)}}:o.resolve;var a;if(a="function"==typeof t?function(e){try{o.resolve(t.call(void 0,e))}catch(n){o.reject(n)}}:o.reject,this.done(i,a),void 0!==n){var s=function(){o.setEstimate(r.getEstimate()+n)};this.observeEstimate(s),s()}return o.promise},Promise.prototype.done=function(e,t){var n=this,i=!1;asap(function(){var r;"function"==typeof e&&(r=Q.onerror?function(t){if(!i){i=!0;try{e.call(void 0,t)}catch(n){(Q.onerror||Promise_rethrow)(n)}}}:function(t){i||(i=!0,e.call(void 0,t))});var o;o="function"==typeof t&&Q.onerror?function(e){if(!i){i=!0,makeStackTraceLong(e,n);try{t.call(void 0,e)}catch(r){(Q.onerror||Promise_rethrow)(r)}}}:"function"==typeof t?function(e){i||(i=!0,makeStackTraceLong(e,n),t.call(void 0,e))}:Q.onerror||Promise_rethrow,"object"==typeof process&&process.domain&&(o=process.domain.bind(o)),Q_inspect(n).dispatch(r,"then",[o])})},Promise.prototype.thenResolve=function(e){return e=Q(e),Q_all([this,e]).then(function(){return e},null,0)},Promise.prototype.thenReject=function(e){return this.then(function(){throw e},null,0)},Promise.prototype.all=function(){return this.then(Q_all)},Promise.prototype.allSettled=function(){return this.then(Q_allSettled)},Promise.prototype.catch=function(e){return this.then(void 0,e)},Promise.prototype.finally=function(e,t){return e?(e=Q(e),this.then(function(t){return e.call().then(function(){return t})},function(t){return e.call().then(function(){throw t})},t)):this},Promise.prototype.observeEstimate=function(e){return this.dispatch("estimate",[e]),this},Promise.prototype.getEstimate=function(){return Q_inspect(this).estimate},Promise.prototype.dispatch=function(e,t){var n=defer();return this.rawDispatch(n.resolve,e,t),n.promise},Promise.prototype.rawDispatch=function(e,t,n){var i=this;asap(function(){Q_inspect(i).dispatch(e,t,n)})},Promise.prototype.get=function(e){return this.dispatch("get",[e])},Promise.prototype.invoke=function(e){for(var t=new Array(arguments.length-1),n=1;n<arguments.length;n++)t[n-1]=arguments[n];return this.dispatch("invoke",[e,t])},Promise.prototype.apply=function(e,t){return this.dispatch("call",[t,e])},Promise.prototype.call=function(e){for(var t=new Array(Math.max(0,arguments.length-1)),n=1;n<arguments.length;n++)t[n-1]=arguments[n];return this.dispatch("call",[t,e])},Promise.prototype.bind=function(e){for(var t=this,n=new Array(Math.max(0,arguments.length-1)),i=1;i<arguments.length;i++)n[i-1]=arguments[i];return function(){for(var i=n.slice(),r=0;r<arguments.length;r++)i[i.length]=arguments[r];return t.dispatch("call",[i,e])}},Promise.prototype.keys=function(){return this.dispatch("keys",[])},Promise.prototype.iterate=function(){return this.dispatch("iterate",[])},Promise.prototype.spread=function(e,t,n){return this.all().then(function(t){return e.apply(void 0,t)},t,n)},Promise.prototype.timeout=function(e,t){var n=defer(),i=setTimeout(function(){n.reject(new Error(t||"Timed out after "+e+" ms"))},e);return this.then(function(e){clearTimeout(i),n.resolve(e)},function(e){clearTimeout(i),n.reject(e)}),n.promise},Promise.prototype.delay=function(e){return this.then(function(t){var n=defer();return n.setEstimate(Date.now()+e),setTimeout(function(){n.resolve(t)},e),n.promise},null,e)},Promise.prototype.pull=function(){return this.dispatch("pull",[])};var promises=new WeakMap;Deferred.prototype.resolve=function(e){var t=Q_inspect(promises.get(this));t.messages&&t.become(Q(e))},Deferred.prototype.reject=function(e){var t=Q_inspect(promises.get(this));t.messages&&t.become(Q_reject(e))},Deferred.prototype.setEstimate=function(e){if(e=+e,e!==e&&(e=1/0),1e12>e&&e!==-1/0)throw new Error("Estimate values should be a number of miliseconds in the future");var t=Q_inspect(promises.get(this));t.setEstimate&&t.setEstimate(e)},Fulfilled.prototype.state="fulfilled",Fulfilled.prototype.inspect=function(){return{state:"fulfilled",value:this.value}},Fulfilled.prototype.dispatch=function(e,t,n){var i;if("then"===t||"get"===t||"call"===t||"invoke"===t||"keys"===t||"iterate"===t||"pull"===t)try{i=this[t].apply(this,n)}catch(r){i=Q_reject(r)}else if("estimate"===t)n[0].call(void 0,this.estimate);else{var o=new Error("Fulfilled promises do not support the "+t+" operator");i=Q_reject(o)}e&&e(i)},Fulfilled.prototype.then=function(){return this.value},Fulfilled.prototype.get=function(e){return this.value[e]},Fulfilled.prototype.invoke=function(e,t){return this.value[e].apply(this.value,t)},Fulfilled.prototype.call=function(e,t){return this.value.apply(t,e)},Fulfilled.prototype.keys=function(){return Object.keys(this.value)},Fulfilled.prototype.iterate=function(){return new Iterator(this.value)},Fulfilled.prototype.pull=function(){var e;if(Object(this.value)===this.value){e=Array.isArray(this.value)?[]:{};for(var t in this.value)e[t]=this.value[t]}else e=this.value;return Q.push(e)},Rejected.prototype.state="rejected",Rejected.prototype.inspect=function(){return{state:"rejected",reason:this.reason}},Rejected.prototype.dispatch=function(e,t,n){var i;i="then"===t?this.then(e,n[0]):this,e&&e(i)},Rejected.prototype.then=function(e,t){return t?t(this.reason):this},Pending.prototype.state="pending",Pending.prototype.inspect=function(){return{state:"pending"}},Pending.prototype.dispatch=function(e,t,n){if(this.messages.push([e,t,n]),"estimate"===t){this.observers.push(n[0]);var i=this;asap(function(){n[0].call(void 0,i.estimate)})}},Pending.prototype.become=function(e){this.became=theViciousCycle;var t=Q_inspect(e);this.became=t,handlers.set(e,t),this.promise=void 0,this.messages.forEach(function(t){asap(function(){var n=Q_inspect(e);n.dispatch.apply(n,t)})}),this.messages=void 0,this.observers=void 0},Pending.prototype.setEstimate=function(e){if(this.observers){var t=this;t.estimate=e,this.observers.forEach(function(t){asap(function(){t.call(void 0,e)})})}},Thenable.prototype.state="thenable",Thenable.prototype.inspect=function(){return{state:"pending"}},Thenable.prototype.cast=function(){if(!this.became){var e=defer(),t=this.thenable;asap(function(){try{t.then(e.resolve,e.reject)}catch(n){e.reject(n)}}),this.became=Q_inspect(e.promise)}return this.became},Thenable.prototype.dispatch=function(e,t,n){this.cast().dispatch(e,t,n)},Q.ninvoke=function(e,t){for(var n=new Array(Math.max(0,arguments.length-1)),i=2;i<arguments.length;i++)n[i-2]=arguments[i];var r=Q.defer();return n[i-2]=makeNodebackResolver(r.resolve),Q(e).dispatch("invoke",[t,n]).catch(r.reject),r.promise},Q.denodeify=function(e,t){return function(){for(var n=new Array(arguments.length+1),i=0;i<arguments.length;i++)n[i]=arguments[i];var r=Q.defer();return n[i]=makeNodebackResolver(r.resolve,t),Q(e).apply(this,n).catch(r.reject),r.promise}},Promise.prototype.nodeify=function(e){return e?(this.done(function(t){e(null,t)},e),void 0):this},Q.nextTick=deprecate(asap,"nextTick","asap package"),Q.resolve=deprecate(Q,"resolve","Q"),Q.fulfill=deprecate(Q,"fulfill","Q"),Q.isPromiseAlike=deprecate(isThenable,"isPromiseAlike","(not supported)"),Q.fail=deprecate(function(e,t){return Q(e).catch(t)},"Q.fail","Q(value).catch"),Q.fin=deprecate(function(e,t){return Q(e).finally(t)},"Q.fin","Q(value).finally"),Q.progress=deprecate(function(e){return e},"Q.progress","no longer supported"),Q.thenResolve=deprecate(function(e,t){return Q(e).thenResolve(t)},"thenResolve","Q(value).thenResolve"),Q.thenReject=deprecate(function(e,t){return Q(e).thenResolve(t)},"thenResolve","Q(value).thenResolve"),Q.isPending=deprecate(function(e){return Q(e).isPending()},"isPending","Q(value).isPending"),Q.isFulfilled=deprecate(function(e){return Q(e).isFulfilled()},"isFulfilled","Q(value).isFulfilled"),Q.isRejected=deprecate(function(e){return Q(e).isRejected()},"isRejected","Q(value).isRejected"),Q.master=deprecate(function(e){return e},"master","no longer necessary"),Q.makePromise=function(){throw new Error("makePromise is no longer supported")},Q.dispatch=deprecate(function(e,t,n){return Q(e).dispatch(t,n)},"dispatch","Q(value).dispatch"),Q.get=deprecate(function(e,t){return Q(e).get(t)},"get","Q(value).get"),Q.keys=deprecate(function(e){return Q(e).keys()},"keys","Q(value).keys"),Q.post=deprecate(function(e,t,n){return Q(e).post(t,n)},"post","Q(value).invoke (spread arguments)"),Q.mapply=deprecate(function(e,t,n){return Q(e).post(t,n)},"post","Q(value).invoke (spread arguments)"),Q.send=deprecate(function(e,t){return Q(e).post(t,Array.prototype.slice.call(arguments,2))},"send","Q(value).invoke"),Q.set=function(){throw new Error("Q.set no longer supported")},Q.delete=function(){throw new Error("Q.delete no longer supported")},Q.nearer=deprecate(function(e){return Q_isPromise(e)&&e.isFulfilled()?e.inspect().value:e},"nearer","inspect().value (+nuances)"),Q.fapply=deprecate(function(e,t){return Q(e).dispatch("call",[t])},"fapply","Q(callback).apply(thisp, args)"),Q.fcall=deprecate(function(e){return Q(e).dispatch("call",[Array.prototype.slice.call(arguments,1)])},"fcall","Q(callback).call(thisp, ...args)"),Q.fbind=deprecate(function(e){var t=Q(e),n=Array.prototype.slice.call(arguments,1);return function(){return t.dispatch("call",[n.concat(Array.prototype.slice.call(arguments)),this])}},"fbind","bind with thisp"),Q.promise=deprecate(Promise,"promise","Promise"),Promise.prototype.fapply=deprecate(function(e){return this.dispatch("call",[e])},"fapply","apply with thisp"),Promise.prototype.fcall=deprecate(function(){return this.dispatch("call",[Array.prototype.slice.call(arguments)])},"fcall","try or call with thisp"),Promise.prototype.fail=deprecate(function(e){return this.catch(e)},"fail","catch"),Promise.prototype.fin=deprecate(function(e){return this.finally(e)},"fin","finally"),Promise.prototype.set=function(){throw new Error("Promise set no longer supported")},Promise.prototype.delete=function(){throw new Error("Promise delete no longer supported")},Deferred.prototype.notify=deprecate(function(){},"notify","no longer supported"),Promise.prototype.progress=deprecate(function(){return this},"progress","no longer supported"),Promise.prototype.mapply=deprecate(function(e,t){return this.dispatch("invoke",[e,t])},"mapply","invoke"),Promise.prototype.fbind=deprecate(function(){return Q.fbind.apply(Q,[void 0].concat(Array.prototype.slice.call(arguments)))},"fbind","bind(thisp, ...args)"),Promise.prototype.send=deprecate(function(){return this.dispatch("invoke",[name,Array.prototype.slice.call(arguments,1)])},"send","invoke"),Promise.prototype.mcall=deprecate(function(){return this.dispatch("invoke",[name,Array.prototype.slice.call(arguments,1)])},"mcall","invoke"),Promise.prototype.passByCopy=deprecate(function(e){return e},"passByCopy","Q.passByCopy"),Q.nfapply=deprecate(function(e,t){var n=Q.defer(),i=Array.prototype.slice.call(t);return i.push(makeNodebackResolver(n.resolve)),Q(e).apply(this,i).catch(n.reject),n.promise},"nfapply"),Promise.prototype.nfapply=deprecate(function(e){return Q.nfapply(this,e)},"nfapply"),Q.nfcall=deprecate(function(e){var t=Array.prototype.slice.call(arguments,1);return Q.nfapply(e,t)},"nfcall"),Promise.prototype.nfcall=deprecate(function(){for(var e=new Array(arguments.length),t=0;t<arguments.length;t++)e[t]=arguments[t];return Q.nfapply(this,e)},"nfcall"),Q.nfbind=deprecate(function(e){var t=Array.prototype.slice.call(arguments,1);return function(){var n=t.concat(Array.prototype.slice.call(arguments)),i=Q.defer();return n.push(makeNodebackResolver(i.resolve)),Q(e).apply(this,n).catch(i.reject),i.promise}},"nfbind","denodeify (with caveats)"),Promise.prototype.nfbind=deprecate(function(){for(var e=new Array(arguments.length),t=0;t<arguments.length;t++)e[t]=arguments[t];return Q.nfbind(this,e)},"nfbind","denodeify (with caveats)"),Q.nbind=deprecate(function(e,t){var n=Array.prototype.slice.call(arguments,2);return function(){function i(){return e.apply(t,arguments)}var r=n.concat(Array.prototype.slice.call(arguments)),o=Q.defer();return r.push(makeNodebackResolver(o.resolve)),Q(i).apply(this,r).catch(o.reject),o.promise}},"nbind","denodeify (with caveats)"),Q.npost=deprecate(function(e,t,n){var i=Q.defer();return n.push(makeNodebackResolver(i.resolve)),Q(e).dispatch("invoke",[t,n]).catch(i.reject),i.promise},"npost","ninvoke (with spread arguments)"),Promise.prototype.npost=deprecate(function(e,t){return Q.npost(this,e,t)},"npost","Q.ninvoke (with caveats)"),Q.makeNodeResolver=deprecate(makeNodebackResolver,"makeNodeResolver"),Promise.prototype.ninvoke=deprecate(function(e){for(var t=new Array(arguments.length-1),n=1;n<arguments.length;n++)t[n-1]=arguments[n];return Q.npost(this,e,t)},"ninvoke","Q.ninvoke"),Q.nmapply=deprecate(Q.nmapply,"nmapply","q/node nmapply"),Promise.prototype.nmapply=deprecate(Promise.prototype.npost,"nmapply","Q.nmapply"),Q.nsend=deprecate(Q.ninvoke,"nsend","q/node ninvoke"),Q.nmcall=deprecate(Q.ninvoke,"nmcall","q/node ninvoke"),Promise.prototype.nsend=deprecate(Promise.prototype.ninvoke,"nsend","q/node ninvoke"),Promise.prototype.nmcall=deprecate(Promise.prototype.ninvoke,"nmcall","q/node ninvoke");var qEndingLine=captureLine();